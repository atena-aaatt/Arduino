#include <ESP8266WiFi.h>

byte echoPin = 5;
byte trigPin = 6;

int sure;
float mesafe;

const char* ssid = "TestHotspot";           // WiFi SSID
const char* password = "12345678";          // WiFi Şifresi
const char* server = "api.thingspeak.com";  /// ThingSpeak sunucusu
String apiKey = "F81HT4U8PMHS6H4B";         // Kanalımıza ait WRITE API KEY

WiFiClient client;

void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  Serial.begin(9600);
  delay(10);

  Serial.println("TestHotspot ağına bağlanılıyor");

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }

  Serial.println("TestHotspot ağına bağlantı sağlandı.");
}

void loop() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(10);
  digitalWrite(trigPin, HIGH);
  delay(250);
  digitalWrite(trigPin, LOW);
  sure = pulseIn(echoPin, HIGH);
  mesafe = (sure / 2) / 29.1;

  if (isnan(mesafe)) {
    Serial.println("Sensör okunamadı...");
    return;
  }

  Serial.print("Mesafe: ");
  Serial.println(mesafe);

  if (client.connect(server, 80)) {
    //api_key=API_KEYIN&field1=DEGER1&field2=DEGER2

    String gidenVeri = "api_key=" + apiKey;
    gidenVeri += "&field1=" + String(mesafe);

    client.println("POST /update HTTP/1.1");
    client.println("Host: api.thingspeak.com");
    client.println("Connection: close");
    client.println("Content-Type: application/x-www-form-urlencoded");
    client.print("Content-Length: ");
    client.println(gidenVeri.length());
    client.println();
    client.println(gidenVeri);

    Serial.println("Mesafe verileri gönderildi...");
  }
  client.stop();
  delay(20000);
 }
